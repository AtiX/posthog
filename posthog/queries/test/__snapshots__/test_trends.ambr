# name: TestTrends.test_weekly_active_users_event_query_base_regression
  '
  
  SELECT groupArray(day_start) as date,
         groupArray(count) AS total
  FROM
    (SELECT SUM(total) AS count,
            day_start
     FROM
       (SELECT toUInt16(0) AS total,
               toStartOfWeek(toDateTime('2023-08-30 23:59:59', 'UTC'), 0) - toIntervalWeek(number) AS day_start
        FROM numbers(dateDiff('week', toStartOfWeek(toDateTime('2023-08-23 00:00:00', 'UTC'), 0), toDateTime('2023-08-30 23:59:59', 'UTC')))
        UNION ALL SELECT toUInt16(0) AS total,
                         toStartOfWeek(toDateTime('2023-08-23 00:00:00', 'UTC'), 0)
        UNION ALL SELECT counts AS total,
                         timestamp AS day_start
        FROM
          (SELECT d.timestamp,
                  COUNT(DISTINCT actor_id) AS counts
           FROM
             (SELECT toDateTime(toStartOfWeek(toDateTime('2023-08-30 23:59:59', 'UTC'), 0) - toIntervalWeek(number)) AS timestamp
              FROM numbers(dateDiff('week', toStartOfWeek(toDateTime('2023-08-16 00:00:00', 'UTC'), 0), toDateTime('2023-08-30 23:59:59', 'UTC')))) d
           CROSS JOIN
             (SELECT toTimeZone(toDateTime(timestamp, 'UTC'), 'UTC') AS timestamp,
                     pdi.person_id AS actor_id
              FROM events e
              INNER JOIN
                (SELECT distinct_id,
                        argMax(person_id, version) as person_id
                 FROM person_distinct_id2
                 WHERE team_id = 2
                 GROUP BY distinct_id
                 HAVING argMax(is_deleted, version) = 0) AS pdi ON e.distinct_id = pdi.distinct_id
              WHERE team_id = 2
                AND event = 'sign up'
                AND toDateTime(timestamp, 'UTC') >= toDateTime('2023-08-16 00:00:00', 'UTC')
                AND toTimeZone(timestamp, 'UTC') <= toDateTime('2023-08-30 23:59:59', 'UTC')
              GROUP BY timestamp, actor_id) e
           WHERE e.timestamp <= d.timestamp + INTERVAL 1 DAY
             AND e.timestamp > d.timestamp - INTERVAL 6 DAY
           GROUP BY d.timestamp
           ORDER BY d.timestamp)
        WHERE 1 = 1
          AND toTimeZone(timestamp, 'UTC') >= toDateTime(toStartOfWeek(toDateTime('2023-08-23 00:00:00', 'UTC'), 0), 'UTC')
          AND toTimeZone(timestamp, 'UTC') <= toDateTime('2023-08-30 23:59:59', 'UTC') )
     GROUP BY day_start
     ORDER BY day_start)
  '
---
