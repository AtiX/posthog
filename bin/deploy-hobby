#!/usr/bin/env bash

set -e

POSTHOG_SECRET=$(head -c 28 /dev/urandom | sha224sum -b | head -c 56)
export POSTHOG_SECRET

# send log of this install for continued support!
curl -s -L --header "Content-Type: application/json" -d '{
    "api_key": "sTMFPsFhdP1Ssg",
    "type": "capture",
    "event": "magic_curl_install"
}' https://app.posthog.com/batch/ > /dev/null


# update apt cache
echo "Grabbing latest apt caches..."
sudo apt update > /dev/null

# clone posthog
echo "Cloning PostHog 🦔 from Github..."
sudo apt install -y git
# try to clone - if folder is already there pull latest for that branch
git clone https://github.com/PostHog/posthog.git &> /dev/null || true
cd posthog
git checkout tags/1.39.1 &> /dev/null
cd ..

cat > Caddyfile <<EOT
# replace :80 with your domain name to get automatic https via LetsEncrypt
:80 {
  reverse_proxy http://web:8000
}
EOT

# start up the stack
rm -f docker-compose.yml
curl -s -S -o docker-compose.hobby.yml https://raw.githubusercontent.com/PostHog/posthog/master/docker-compose.hobby.yml > /dev/null
envsubst < docker-compose.hobby.yml > docker-compose.yml
rm docker-compose.hobby.yml

echo "🎉🎉🎉 Welcome to PostHog! 🎉🎉🎉"
echo ""
echo "For a full guide on how to customize and deploy PostHog, check out https://posthog.com/docs/self-host/deploy/hobby"
echo ""
echo "P.S: It's dangerous to go alone! Take this: 🦔"
