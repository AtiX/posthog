#!/bin/sh

set -e

# If recorder.js files don't exist in posthog-js/dist generate recorder.js the old way to maintain backwards compatibility.
# `recorder.js` files are explicitly built in posthog-js starting from v1.44.0
FILE=node_modules/posthog-js/dist/recorder.js
if [ -f "$FILE" ]; then

  cp node_modules/posthog-js/dist/recorder.js frontend/dist/recorder.js
  cp node_modules/posthog-js/dist/recorder.js.map frontend/dist/recorder.js.map

else

  cp node_modules/rrweb/dist/record/rrweb-record.min.js frontend/dist/recorder.js
  cp node_modules/rrweb/dist/record/rrweb-record.min.js.map frontend/dist/recorder.js.map
  sed -i -e s/rrweb-record.min.js.map/recorder.js.map/ frontend/dist/recorder.js

  cat node_modules/rrweb/dist/plugins/console-record.min.js >> frontend/dist/recorder.js
  cp node_modules/rrweb/dist/plugins/console-record.min.js.map frontend/dist/console-record.min.js.map

  sed -i -e 's/\/\/\# sourceMappingURL=recorder/window.rrweb = {record: rrwebRecord}\n\/\/# sourceMappingURL=recorder/g' frontend/dist/recorder.js

fi

