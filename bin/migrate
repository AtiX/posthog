#!/bin/bash
set -e

python manage.py migrate
python manage.py migrate_clickhouse

# NOTE: we do not apply any non-noop migrations here. Rather these are run
# manually within the UI. See https://posthog.com/docs/runbook/async-migrations
# for details.
python manage.py run_async_migrations --complete-noop-migrations

# NOTE: this check should not fail if a migration isn't complete but within the
# given async migration posthog version range, thus this should not block e.g.
# k8s pod deployments.
python manage.py run_async_migrations --check

python manage.py sync_replicated_schema

# We need to handle migration of consumer group offsets such that we don't start
# from the begining after https://github.com/PostHog/posthog/pull/13049 is
# merged, otherwise we may end up ingesting duplicate rows into ClickHouse.
python manage.py migrate_clickhouse_consumer_offsets
