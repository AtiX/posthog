name: e2e - hobby ingestion test

on:
  pull_request:
    types:
      - opened
    paths:
      - docker-compose.hobby.yml 
      - bin/deploy-hobby 
      - .github/workflows/ci-hobby-deploy.yml

env:
    POSTHOG_API_HOST: "localhost"
    POSTHOG_EVENT_ENDPOINT: 'https://localhost'
    POSTHOG_API_ENDPOINT: 'https://localhost'
    SKIP_SOURCE_IP_ADDRESS_CHECK: 'true'

jobs:
  test-compose:
    runs-on: ubuntu-20.04
    timeout-minutes: 30

    steps:
      - name: Checkout master 
        uses: actions/checkout@v2

      - name: Borrow k6 tests from charts-clickhouse
        uses: actions/checkout@v2
        with:
            repository: 'posthog/charts-clickhouse' 
            path: 'charts-clickhouse/'

      - name: Create temp directory
        run: mkdir tmp

      - name: Execute the hobby script 
        run: |
            cd tmp
            printf "n\n$POSTHOG_API_HOST\n\n" | ../bin/deploy-hobby 

      - name: Test health endpoint
        run: |
            curl -kv https://$POSTHOG_API_HOST/_health

      - name: Setup PostHog for the ingestion test
        run: docker-compose -f tmp/docker-compose.yml run web python manage.py setup_dev --no-data 

      - name: Run ingestion test using k6
        uses: grafana/k6-action@v0.2.0
        with:
          filename: charts-clickhouse/ci/k6/ingestion-test.js
          flags: --insecure-skip-tls-verify